name: Tests

on: [push, pull_request]

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-22.04

    env:
      JOBS: 1  # must be 1 as socket tests interfere with each other
      OPENRESTY: ${{ matrix.openresty }}
      CODE_PATH: ${{ github.workspace }}
      BASE_PATH: /home/runner/work/cache

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2

    - name: Install packages
      run: |
        sudo apt-get -y install --no-install-recommends wget gnupg ca-certificates
        wget -O - https://openresty.org/package/pubkey.gpg | sudo gpg --dearmor -o /usr/share/keyrings/openresty.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/openresty.gpg] http://openresty.org/package/ubuntu $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/openresty.list > /dev/null
        sudo apt-get update
        sudo apt-get -y install --no-install-recommends openresty
        luarocks install busted luacheck

    - name: Lint
      run: |
        luacheck .

    - name: Busted Tests
      run: |
        busted
